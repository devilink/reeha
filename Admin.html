<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Label Reeha - Admin Panel</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark': '#1a1a1a',
                        'brand-gold': '#d4af37',
                        'brand-cream': '#f5f0eb',
                        'brand-gray': '#8c8c8c',
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Montserrat"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- AWS SDK -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1001.0.min.js"></script>

    <style>
        body {
            background-color: #f9f7f2;
            color: #1a1a1a;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #d4af37;
        }

        .btn-gold {
            background: linear-gradient(135deg, #b8860b, #d4af37);
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 4px;
            transition: transform 0.2s, opacity 0.2s;
            cursor: pointer;
        }

        .btn-gold:hover {
            transform: translateY(-2px);
            opacity: 0.95;
        }
    </style>
    <script>
        // Simple Client-Side Password Protection
        const password = prompt("Enter Admin Password:");
        if (password !== "LabelReeha2026") {
            alert("Incorrect Password!");
            window.location.href = "index.html";
        }
    </script>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-serif font-bold text-brand-gold">Label Reeha <span
                    class="text-sm font-sans text-brand-dark uppercase tracking-widest ml-2">Admin</span></h1>
            <a href="Shop.html"
                class="text-sm uppercase tracking-widest font-bold hover:text-brand-gold transition-colors">Back to
                Shop</a>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-6 py-12 max-w-4xl">

        <!-- AWS Configuration Section -->
        <section class="bg-white p-8 rounded-lg shadow-md mb-12 border border-[#eaeaea]">
            <h2 class="text-2xl font-serif mb-6 flex items-center gap-3">
                <i class="fas fa-cog text-brand-gold"></i> AWS Configuration
            </h2>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-1">Region</label>
                        <input type="text" id="aws-region" class="form-input" placeholder="e.g., ap-south-1">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-1">DynamoDB Table Name</label>
                        <input type="text" id="aws-table" class="form-input" placeholder="e.g., Products">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-1">S3 Bucket Name</label>
                        <input type="text" id="aws-bucket" class="form-input" placeholder="e.g., label-reeha-images">
                    </div>
                    <!-- Credentials (masked) -->
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-1">Access Key ID</label>
                        <input type="password" id="aws-access-key" class="form-input" placeholder="AWS Access Key">
                    </div>
                </div>
                <div>
                    <label class="block text-xs uppercase font-bold text-gray-500 mb-1">Secret Access Key</label>
                    <input type="password" id="aws-secret-key" class="form-input" placeholder="AWS Secret Key">
                </div>

                <div class="flex justify-between items-center mt-4">
                    <p class="text-xs text-red-500 italic">* Credentials are stored locally in your browser only.</p>
                    <button id="save-config-btn" class="text-brand-gold text-sm font-bold hover:underline">Save
                        Configuration</button>
                </div>
            </div>
        </section>

        <!-- Product Upload Section -->
        <section class="bg-white p-8 rounded-lg shadow-md border border-[#eaeaea] relative">
            <div id="loader" class="hidden absolute inset-0 bg-white/80 z-10 flex justify-center items-center flex-col">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-gold mb-4"></div>
                <p class="font-serif">Uploading...</p>
            </div>

            <h2 class="text-2xl font-serif mb-6 flex items-center gap-3">
                <i class="fas fa-plus text-brand-gold"></i> <span id="form-title">Add New Product</span>
            </h2>

            <input type="hidden" id="edit-product-id">
            <input type="hidden" id="current-image-url">

            <form id="product-form" class="space-y-6">
                <!-- Image Upload -->
                <div>
                    <label class="block text-xs uppercase font-bold text-gray-500 mb-2">Product Image</label>
                    <div class="flex items-center justify-center w-full">
                        <label for="product-image"
                            class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span>
                                </p>
                                <p class="text-xs text-gray-500">JPG, PNG (MAX. 5MB)</p>
                            </div>
                            <input id="product-image" type="file" class="hidden" accept="image/*" />
                        </label>
                    </div>
                    <div id="image-preview-container" class="mt-4 hidden p-2 border rounded">
                        <p class="text-xs font-bold text-gray-500 mb-2">Preview:</p>
                        <img id="image-preview" src="" alt="Preview" class="h-40 w-auto object-contain rounded">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-1">Product Name</label>
                        <input type="text" id="product-name" class="form-input" placeholder="e.g., Label Reeha-X"
                            required>
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-1">Price (₹)</label>
                        <input type="number" id="product-price" class="form-input" placeholder="e.g., 1200" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-1">Instagram Link</label>
                        <div class="flex items-center">
                            <span class="bg-gray-100 p-3 border border-r-0 border-ddd rounded-l text-gray-500"><i
                                    class="fab fa-instagram"></i></span>
                            <input type="url" id="product-insta" class="form-input rounded-l-none"
                                placeholder="https://instagram.com/p/..." required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-1">Facebook Link</label>
                        <div class="flex items-center">
                            <span class="bg-gray-100 p-3 border border-r-0 border-ddd rounded-l text-gray-500"><i
                                    class="fab fa-facebook-f"></i></span>
                            <input type="url" id="product-fb" class="form-input rounded-l-none"
                                placeholder="https://facebook.com/..." required>
                        </div>
                    </div>
                </div>

                <div class="pt-4 border-t mt-4 flex justify-between items-center">
                    <button type="button" id="cancel-edit-btn"
                        class="hidden text-gray-500 hover:text-gray-800 text-sm font-bold">Cancel Edit</button>
                    <button type="submit" id="submit-btn" class="btn-gold shadow-lg shadow-orange-100">
                        Upload Product <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </form>
        </section>

        <!-- Product List Section -->
        <section class="bg-white p-8 rounded-lg shadow-md border border-[#eaeaea]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-serif flex items-center gap-3">
                    <i class="fas fa-list text-brand-gold"></i> Product List
                </h2>
                <button onclick="fetchProducts()" class="text-sm font-bold text-gray-500 hover:text-brand-gold"><i
                        class="fas fa-sync-alt mr-1"></i> Refresh</button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs uppercase text-gray-400 border-b">
                            <th class="py-3">Image</th>
                            <th class="py-3">Name</th>
                            <th class="py-3">Price</th>
                            <th class="py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="product-list-body">
                        <!-- Items rendered here -->
                        <tr>
                            <td colspan="4" class="text-center py-4 text-gray-400">Loading or empty...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <script>
        // --- 1. CONFIGURATION LODING/SAVING ---
        const fields = ['aws-region', 'aws-table', 'aws-bucket', 'aws-access-key', 'aws-secret-key'];

        function loadConfig() {
            fields.forEach(field => {
                const val = localStorage.getItem(field);
                if (val) document.getElementById(field).value = val;
            });
        }

        document.getElementById('save-config-btn').addEventListener('click', () => {
            fields.forEach(field => {
                const val = document.getElementById(field).value;
                if (val) localStorage.setItem(field, val);
            });
            alert("Configuration Saved!");
            location.reload();
        });

        // Initialize Config & Fetch Products
        loadConfig();


        // --- 2. IMAGE PREVIEW ---
        const imageInput = document.getElementById('product-image');
        const previewContainer = document.getElementById('image-preview-container');
        const previewImage = document.getElementById('image-preview');

        imageInput.addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    previewImage.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        });

        // --- 3. FETCH & LIST LOGIC ---
        async function fetchProducts() {
            const region = document.getElementById('aws-region').value;
            const tableName = document.getElementById('aws-table').value;
            const accessKeyId = document.getElementById('aws-access-key').value;
            const secretAccessKey = document.getElementById('aws-secret-key').value;

            if (!region || !tableName || !accessKeyId || !secretAccessKey) {
                // Keep silent or show a small message if config is missing
                console.log("Waiting for credentials...");
                return;
            }

            AWS.config.update({
                region: region,
                accessKeyId: accessKeyId,
                secretAccessKey: secretAccessKey
            });

            const docClient = new AWS.DynamoDB.DocumentClient();
            const listBody = document.getElementById('product-list-body');

            try {
                const data = await docClient.scan({ TableName: tableName }).promise();
                const products = data.Items || [];
                products.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

                listBody.innerHTML = '';
                if (products.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">No products found.</td></tr>';
                    return;
                }

                products.forEach(p => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50 transition-colors';
                    row.innerHTML = `
                        <td class="py-3"><img src="${p.imageUrl}" class="w-12 h-12 object-cover rounded border"></td>
                        <td class="py-3 font-medium">${p.name}</td>
                        <td class="py-3">₹${p.price}</td>
                        <td class="py-3 text-right space-x-2">
                            <button class="text-blue-500 hover:text-blue-700" onclick='initEdit(${JSON.stringify(p)})'><i class="fas fa-edit"></i></button>
                            <button class="text-red-500 hover:text-red-700" onclick="deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    listBody.appendChild(row);
                });

            } catch (err) {
                console.error(err);
                if (err.code === 'UnrecognizedClientException' || err.code === 'AccessDeniedException') {
                    // ignore if config not ready
                } else {
                    listBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Error: ${err.message}</td></tr>`;
                }
            }
        }

        // --- 4. DELETE LOGIC ---
        async function deleteProduct(id) {
            if (!confirm("Are you sure you want to delete this product?")) return;

            const tableName = document.getElementById('aws-table').value;
            const docClient = new AWS.DynamoDB.DocumentClient();

            try {
                await docClient.delete({
                    TableName: tableName,
                    Key: { id: id }
                }).promise();
                alert("Product deleted!");
                fetchProducts();
            } catch (err) {
                alert("Error deleting: " + err.message);
            }
        }

        // --- 5. EDIT MODE LOGIC ---
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const editIdInput = document.getElementById('edit-product-id');
        const currentUrlInput = document.getElementById('current-image-url');

        function initEdit(product) {
            // Populate Form
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-insta').value = product.instaUrl || '';
            document.getElementById('product-fb').value = product.fbUrl || '';

            // Set Hidden Inputs
            editIdInput.value = product.id;
            currentUrlInput.value = product.imageUrl;

            // Show Preview
            previewImage.src = product.imageUrl;
            previewContainer.classList.remove('hidden');

            // UI Changes
            formTitle.innerText = "Edit Product";
            submitBtn.innerHTML = 'Update Product <i class="fas fa-save ml-2"></i>';
            cancelBtn.classList.remove('hidden');

            // Scroll to form
            document.getElementById('product-form').scrollIntoView({ behavior: 'smooth' });
        }

        cancelBtn.addEventListener('click', resetForm);

        function resetForm() {
            document.getElementById('product-form').reset();
            editIdInput.value = '';
            currentUrlInput.value = '';
            previewContainer.classList.add('hidden');
            formTitle.innerText = "Add New Product";
            submitBtn.innerHTML = 'Upload Product <i class="fas fa-arrow-right ml-2"></i>';
            cancelBtn.classList.add('hidden');
        }

        // --- 6. CREATE / UPDATE LOGIC ---
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get Config
            const region = document.getElementById('aws-region').value;
            const tableName = document.getElementById('aws-table').value;
            const bucketName = document.getElementById('aws-bucket').value;
            const accessKeyId = document.getElementById('aws-access-key').value;
            const secretAccessKey = document.getElementById('aws-secret-key').value;

            if (!region || !tableName || !bucketName || !accessKeyId || !secretAccessKey) {
                alert('Please fill in all AWS Configuration fields first!');
                return;
            }

            // Init AWS
            AWS.config.update({
                region: region,
                accessKeyId: accessKeyId,
                secretAccessKey: secretAccessKey
            });

            const s3 = new AWS.S3({
                apiVersion: '2006-03-01',
                params: { Bucket: bucketName }
            });
            const docClient = new AWS.DynamoDB.DocumentClient();

            // Data
            const file = imageInput.files[0];
            const name = document.getElementById('product-name').value;
            const price = document.getElementById('product-price').value;
            const instaUrl = document.getElementById('product-insta').value;
            const fbUrl = document.getElementById('product-fb').value;

            const isEdit = !!editIdInput.value;
            const productId = isEdit ? editIdInput.value : 'prod_' + Date.now();
            let imageUrl = isEdit ? currentUrlInput.value : '';

            // Validation: New products need image, Edits act optionally
            if (!isEdit && !file) {
                alert('Please select an image!');
                return;
            }

            // Show Loader
            document.getElementById('loader').classList.remove('hidden');

            try {
                // 1. Upload Image (If selected)
                if (file) {
                    const fileName = `products/${productId}_${file.name}`;
                    const uploadResult = await s3.upload({
                        Key: fileName,
                        Body: file,
                        ContentType: file.type
                    }).promise();
                    imageUrl = uploadResult.Location;
                }

                // 2. Put Item in DynamoDB (Create or Update)
                const item = {
                    id: productId,
                    name: name,
                    price: Number(price),
                    imageUrl: imageUrl,
                    instaUrl: instaUrl,
                    fbUrl: fbUrl,
                    createdAt: isEdit ? undefined : new Date().toISOString() // Keep original creation date logic if desired, or just set it
                };

                // If update, we might want to preserve createdAt, but PUT overwrites. 
                // Simple workaround: if edit, don't change createdAt. 
                // However, reading it first adds latency. For simplicity, we'll update everything. 
                // Ideally, use UpdateItem, but PutItem is easier. 
                if (!item.createdAt) item.createdAt = new Date().toISOString();

                await docClient.put({
                    TableName: tableName,
                    Item: item
                }).promise();

                // Success
                alert(isEdit ? 'Product updated!' : 'Product uploaded!');
                resetForm();
                fetchProducts(); // Refresh list

            } catch (err) {
                console.error('Error:', err);
                alert('An error occurred: ' + err.message);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        });

        // Initial Fetch
        fetchProducts();

    </script>
</body>

</html>